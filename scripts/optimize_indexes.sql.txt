-- =============================================================================
-- PERFORMANCE OVERHAUL V3: Standardized Indices & Sort Optimization
-- Fixes 57014 Timeouts by providing B-Tree support for Grid sorting.
-- =============================================================================

-- 1. Enable Trigram Extension
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- 2. CLEANUP: Remove ALL known legacy/duplicate/test indices
DROP INDEX IF EXISTS idx_app_taxa_name;
DROP INDEX IF EXISTS idx_app_taxa_name_search;
DROP INDEX IF EXISTS idx_app_taxa_name_sort;
DROP INDEX IF EXISTS idx_app_taxa_name_sort_c;
DROP INDEX IF EXISTS trgm_idx_app_taxa_name;
DROP INDEX IF EXISTS idx_app_taxa_name_trgm;
DROP INDEX IF EXISTS idx_app_taxa_genus;
DROP INDEX IF EXISTS idx_app_taxa_species;
DROP INDEX IF EXISTS idx_app_taxa_species_standalone;
DROP INDEX IF EXISTS idx_app_taxa_species_alone;
DROP INDEX IF EXISTS idx_app_taxa_family;
DROP INDEX IF EXISTS idx_app_taxa_rank;
DROP INDEX IF EXISTS idx_app_taxa_status;
DROP INDEX IF EXISTS idx_app_taxa_cultivar;
DROP INDEX IF EXISTS idx_app_taxa_gh;
DROP INDEX IF EXISTS idx_app_taxa_sh;
DROP INDEX IF EXISTS idx_app_taxa_wcvp_id;
DROP INDEX IF EXISTS idx_app_taxa_wcvp;
DROP INDEX IF EXISTS idx_app_taxa_ipni;
DROP INDEX IF EXISTS idx_app_taxa_powo;
DROP INDEX IF EXISTS idx_app_taxa_parent_id;
DROP INDEX IF EXISTS idx_app_taxa_parent;
DROP INDEX IF EXISTS idx_app_taxa_accepted_id;
DROP INDEX IF EXISTS idx_app_taxa_accepted_wcvp;
DROP INDEX IF EXISTS idx_app_taxa_parent_plant_name_id;
DROP INDEX IF EXISTS idx_app_taxa_parent_wcvp;
DROP INDEX IF EXISTS idx_app_taxa_basionym_id;
DROP INDEX IF EXISTS idx_app_taxa_basionym_wcvp;
DROP INDEX IF EXISTS idx_app_taxa_geo;
DROP INDEX IF EXISTS idx_app_taxa_path_gist;
DROP INDEX IF EXISTS idx_app_taxa_source;
DROP INDEX IF EXISTS idx_app_taxa_source_nulls;

-- 3. NOMENCLATURE SEARCH & SORT (CRITICAL)
-- B-Tree Index for ORDER BY and Prefix LIKE. Uses COLLATE "C" for max performance.
CREATE INDEX IF NOT EXISTS idx_app_taxa_name_sort ON app_taxa (taxon_name COLLATE "C");

-- Case-insensitive functional index for background lineage matching
CREATE INDEX IF NOT EXISTS idx_app_taxa_name_ci ON app_taxa (LOWER(TRIM(taxon_name)));

-- GIN Index: Fast wildcard search (ILIKE '%term%')
CREATE INDEX IF NOT EXISTS idx_app_taxa_taxon_name_trgm ON app_taxa USING GIN (taxon_name gin_trgm_ops);

-- 4. HIERARCHY & COMBINATION FILTERS
-- Composite for Genus + Species searches
CREATE INDEX IF NOT EXISTS idx_app_taxa_genus_species ON app_taxa (genus, species);

-- Standalone sort support for major columns
CREATE INDEX IF NOT EXISTS idx_app_taxa_family ON app_taxa(family COLLATE "C");
CREATE INDEX IF NOT EXISTS idx_app_taxa_genus ON app_taxa(genus COLLATE "C");
CREATE INDEX IF NOT EXISTS idx_app_taxa_species ON app_taxa(species COLLATE "C");
CREATE INDEX IF NOT EXISTS idx_app_taxa_rank ON app_taxa(taxon_rank);
CREATE INDEX IF NOT EXISTS idx_app_taxa_status ON app_taxa(taxon_status);
CREATE INDEX IF NOT EXISTS idx_app_taxa_cultivar ON app_taxa(cultivar COLLATE "C");

-- Hybrid Markers
CREATE INDEX IF NOT EXISTS idx_app_taxa_gh ON app_taxa(genus_hybrid);
CREATE INDEX IF NOT EXISTS idx_app_taxa_sh ON app_taxa(species_hybrid);

-- 5. IDENTIFIER LOOKUPS (Internal & External)
CREATE INDEX IF NOT EXISTS idx_app_taxa_wcvp ON app_taxa(wcvp_id);
CREATE INDEX IF NOT EXISTS idx_app_taxa_ipni ON app_taxa(ipni_id);
CREATE INDEX IF NOT EXISTS idx_app_taxa_powo ON app_taxa(powo_id);
CREATE INDEX IF NOT EXISTS idx_app_taxa_parent ON app_taxa(parent_id);
CREATE INDEX IF NOT EXISTS idx_app_taxa_source ON app_taxa(source_id);
CREATE INDEX IF NOT EXISTS idx_app_taxa_accepted_wcvp ON app_taxa(accepted_plant_name_id);
CREATE INDEX IF NOT EXISTS idx_app_taxa_parent_plant_name_id ON app_taxa(parent_plant_name_id);
CREATE INDEX IF NOT EXISTS idx_app_taxa_basionym_wcvp ON app_taxa(basionym_plant_name_id);

-- Partial index for high-speed maintenance operations (Purge)
CREATE INDEX IF NOT EXISTS idx_app_taxa_source_nulls ON app_taxa (source_id) WHERE source_id IS NULL;

-- 6. GEOGRAPHIC & PATHS
CREATE INDEX IF NOT EXISTS idx_app_taxa_path_gist ON app_taxa USING GIST (hierarchy_path);
CREATE INDEX IF NOT EXISTS idx_app_taxa_geo_trgm ON app_taxa USING GIN (geographic_area gin_trgm_ops);

-- 7. Refresh Statistics
ANALYZE app_taxa;

SELECT 'Performance tuning complete. Table statistics refreshed.' as status;