-- =============================================================================
-- PERFORMANCE OVERHAUL V8.3: Production Search & Sort Optimization
-- Ensures high-speed grid filtering and sorting on 1.4M rows.
-- =============================================================================

-- 1. Enable Trigram Extension
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- 2. CLEANUP: Remove legacy or redundant indexes
DROP INDEX IF EXISTS idx_app_taxa_name_sort;
DROP INDEX IF EXISTS idx_app_taxa_taxon_name_trgm;
DROP INDEX IF EXISTS idx_bridge_family_lookup;

-- 3. STORAGE LAYER OPTIMIZATION
-- Ensure COLLATE "C" for high-speed sort and join operations
ALTER TABLE app_taxa ALTER COLUMN taxon_name SET DATA TYPE text COLLATE "C";
ALTER TABLE app_taxa ALTER COLUMN family SET DATA TYPE text COLLATE "C";
ALTER TABLE app_taxa ALTER COLUMN taxon_rank SET DATA TYPE text COLLATE "C";

-- 4. NOMENCLATURE SEARCH & SORT (Primary Search Interface)
CREATE INDEX idx_app_taxa_name_sort ON app_taxa (taxon_name COLLATE "C");
CREATE INDEX idx_app_taxa_taxon_name_trgm ON app_taxa USING GIN (taxon_name gin_trgm_ops);

-- 5. HIGH-SPEED COMPOSITE FILTERS (V8 Sort-Inclusive)
CREATE INDEX IF NOT EXISTS idx_app_taxa_status_rank_sort ON app_taxa (taxon_status, taxon_rank, taxon_name);
CREATE INDEX IF NOT EXISTS idx_app_taxa_genus_species_sort ON app_taxa (genus, species, taxon_name);

-- 6. HIERARCHY & GRID FILTERS
CREATE INDEX IF NOT EXISTS idx_app_taxa_family ON app_taxa(family COLLATE "C");
CREATE INDEX IF NOT EXISTS idx_app_taxa_parent ON app_taxa(parent_id);
CREATE INDEX IF NOT EXISTS idx_app_taxa_source_id ON app_taxa(source_id);

-- 7. Refresh Statistics
ANALYZE app_taxa;

SELECT 'V8.3 Performance Tuning Complete. Production Indices Active.' as status;