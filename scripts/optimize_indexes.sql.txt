-- =============================================================================
-- PERFORMANCE OVERHAUL V8.1: Name-Inclusive Composite Filters & Redundancy Cleanup
-- Resolves timeouts when filtering sparse ranks (Form, f.) by providing
-- pre-sorted data to the "ORDER BY taxon_name COLLATE 'C'" operation.
-- RECLAIMS: ~100MB of storage by removing shadowed indexes.
-- =============================================================================

-- 1. Enable Trigram Extension
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- 2. CLEANUP: Remove ALL legacy, duplicate, or shadowed indexes
DROP INDEX IF EXISTS idx_app_taxa_name;
DROP INDEX IF EXISTS idx_app_taxa_name_search;
DROP INDEX IF EXISTS idx_app_taxa_name_sort;
DROP INDEX IF EXISTS idx_app_taxa_name_exact;
DROP INDEX IF EXISTS idx_app_taxa_name_sort_c;
DROP INDEX IF EXISTS trgm_idx_app_taxa_name;
DROP INDEX IF EXISTS idx_app_taxa_name_trgm;
DROP INDEX IF EXISTS idx_app_taxa_taxon_name_trgm; -- Corrected name sync
DROP INDEX IF EXISTS idx_app_taxa_genus;
DROP INDEX IF EXISTS idx_app_taxa_species;
DROP INDEX IF EXISTS idx_app_taxa_species_alone;
DROP INDEX IF EXISTS idx_app_taxa_family;
DROP INDEX IF EXISTS idx_app_taxa_rank;
DROP INDEX IF EXISTS idx_app_taxa_status;
DROP INDEX IF EXISTS idx_app_taxa_infraspecific_rank;
DROP INDEX IF EXISTS idx_app_taxa_infraspecies;
DROP INDEX IF EXISTS idx_app_taxa_cultivar;
DROP INDEX IF EXISTS idx_app_taxa_gh;
DROP INDEX IF EXISTS idx_app_taxa_sh;
DROP INDEX IF EXISTS idx_app_taxa_wcvp_id;
DROP INDEX IF EXISTS idx_app_taxa_wcvp;
DROP INDEX IF EXISTS idx_app_taxa_ipni;
DROP INDEX IF EXISTS idx_app_taxa_powo;
DROP INDEX IF EXISTS idx_app_taxa_parent_id;
DROP INDEX IF EXISTS idx_app_taxa_parent;
DROP INDEX IF EXISTS idx_app_taxa_accepted_id;
DROP INDEX IF EXISTS idx_app_taxa_accepted_wcvp;
DROP INDEX IF EXISTS idx_app_taxa_parent_plant_name_id;
DROP INDEX IF EXISTS idx_app_taxa_parent_wcvp;
DROP INDEX IF EXISTS idx_app_taxa_basionym_id;
DROP INDEX IF EXISTS idx_app_taxa_basionym_wcvp;
DROP INDEX IF EXISTS idx_app_taxa_geo;
DROP INDEX IF EXISTS idx_app_taxa_path_gist;
DROP INDEX IF EXISTS idx_app_taxa_source;
DROP INDEX IF EXISTS idx_app_taxa_source_id;
DROP INDEX IF EXISTS idx_app_taxa_source_nulls;
DROP INDEX IF EXISTS idx_app_taxa_source_id_filter;
DROP INDEX IF EXISTS idx_app_taxa_name_ci;
DROP INDEX IF EXISTS idx_app_taxa_status_rank;
DROP INDEX IF EXISTS idx_app_taxa_status_irank;
-- Shadowed V8 Cleanup
DROP INDEX IF EXISTS idx_app_taxa_status_rank_sort;
DROP INDEX IF EXISTS idx_app_taxa_status_irank_sort;
DROP INDEX IF EXISTS idx_build_path_null;

-- 3. STORAGE LAYER OPTIMIZATION (CRITICAL)
-- Ensure COLLATE "C" at the column level for all nomenclature and metadata.
ALTER TABLE app_taxa ALTER COLUMN taxon_name SET DATA TYPE text COLLATE "C";
ALTER TABLE app_taxa ALTER COLUMN family SET DATA TYPE text COLLATE "C";
ALTER TABLE app_taxa ALTER COLUMN genus SET DATA TYPE text COLLATE "C";
ALTER TABLE app_taxa ALTER COLUMN species SET DATA TYPE text COLLATE "C";
ALTER TABLE app_taxa ALTER COLUMN infraspecies SET DATA TYPE text COLLATE "C";
ALTER TABLE app_taxa ALTER COLUMN cultivar SET DATA TYPE text COLLATE "C";
ALTER TABLE app_taxa ALTER COLUMN taxon_rank SET DATA TYPE text COLLATE "C";
ALTER TABLE app_taxa ALTER COLUMN taxon_status SET DATA TYPE text COLLATE "C";
ALTER TABLE app_taxa ALTER COLUMN infraspecific_rank SET DATA TYPE text COLLATE "C";

-- 4. NOMENCLATURE SEARCH & SORT
CREATE INDEX IF NOT EXISTS idx_app_taxa_name_sort ON app_taxa (taxon_name);
CREATE INDEX IF NOT EXISTS idx_app_taxa_taxon_name_trgm ON app_taxa USING GIN (taxon_name gin_trgm_ops);
CREATE INDEX IF NOT EXISTS idx_app_taxa_name_ci ON app_taxa (LOWER(TRIM(taxon_name)));

-- 5. HIGH-SPEED COMPOSITE FILTERS (V8 Sort-Inclusive)
-- These allow the DB to find matches AND return them pre-sorted by name, 
-- eliminating the expensive "re-sort" that causes 57014 timeouts.
-- Note: These shadow standard (status, rank) indexes.
CREATE INDEX IF NOT EXISTS idx_app_taxa_status_rank_sort ON app_taxa (taxon_status, taxon_rank, taxon_name);
CREATE INDEX IF NOT EXISTS idx_app_taxa_status_irank_sort ON app_taxa (taxon_status, infraspecific_rank, taxon_name);
CREATE INDEX IF NOT EXISTS idx_app_taxa_genus_species_sort ON app_taxa (genus, species, taxon_name);

-- 6. HIERARCHY & OTHER FILTERS
CREATE INDEX IF NOT EXISTS idx_app_taxa_family ON app_taxa(family);
CREATE INDEX IF NOT EXISTS idx_app_taxa_genus ON app_taxa(genus);
CREATE INDEX IF NOT EXISTS idx_app_taxa_species ON app_taxa(species);
CREATE INDEX IF NOT EXISTS idx_app_taxa_status ON app_taxa(taxon_status);
CREATE INDEX IF NOT EXISTS idx_app_taxa_infraspecies ON app_taxa(infraspecies);
CREATE INDEX IF NOT EXISTS idx_app_taxa_cultivar ON app_taxa(cultivar);
CREATE INDEX IF NOT EXISTS idx_app_taxa_gh ON app_taxa(genus_hybrid);
CREATE INDEX IF NOT EXISTS idx_app_taxa_sh ON app_taxa(species_hybrid);

-- 7. IDENTIFIER LOOKUPS
-- Note: wcvp_id is handled by app_taxa_wcvp_id_key (Unique constraint index)
CREATE INDEX IF NOT EXISTS idx_app_taxa_ipni ON app_taxa(ipni_id);
CREATE INDEX IF NOT EXISTS idx_app_taxa_powo ON app_taxa(powo_id);
CREATE INDEX IF NOT EXISTS idx_app_taxa_parent ON app_taxa(parent_id);
CREATE INDEX IF NOT EXISTS idx_app_taxa_accepted_wcvp ON app_taxa(accepted_plant_name_id);
CREATE INDEX IF NOT EXISTS idx_app_taxa_parent_plant_name_id ON app_taxa(parent_plant_name_id);
CREATE INDEX IF NOT EXISTS idx_app_taxa_basionym_wcvp ON app_taxa(basionym_plant_name_id);

-- 8. MAINTENANCE & GEOGRAPHIC
CREATE INDEX IF NOT EXISTS idx_app_taxa_source_id ON app_taxa(source_id);
CREATE INDEX IF NOT EXISTS idx_app_taxa_source_id_filter ON app_taxa (source_id) WHERE source_id IS NULL OR source_id <> 1;
CREATE INDEX IF NOT EXISTS idx_app_taxa_path_gist ON app_taxa USING GIST (hierarchy_path);
CREATE INDEX IF NOT EXISTS idx_app_taxa_geo_trgm ON app_taxa USING GIN (geographic_area gin_trgm_ops);

-- 9. Refresh Statistics
ANALYZE app_taxa;

-- 10. STEP 11 BUILD BOOSTER (Added v2.31.20)
-- DANGER: This partial index is only useful DURING the build process.
-- It shrinks as work is done, allowing Level 2, 3, 4 etc to run instantly.
CREATE INDEX IF NOT EXISTS idx_build_path_null ON app_taxa (parent_id) WHERE hierarchy_path IS NULL;

SELECT 'Index cleanup and V8.1 Sort-Inclusive optimization complete.' as status;