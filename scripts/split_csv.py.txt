import csv
import os
import sys

def split_csv():
    # Configuration
    INPUT_FILENAME = 'wcvp_names_clean.csv'
    ROWS_PER_FILE = 100000
    
    if not os.path.exists(INPUT_FILENAME):
        print(f"Error: Input file '{INPUT_FILENAME}' not found.")
        print("Please run 'convert_wcvp.py' first.")
        return

    print(f"Splitting '{INPUT_FILENAME}' into chunks of {ROWS_PER_FILE:,} rows...")

    try:
        # Increase field size limit for safety with large text fields
        csv.field_size_limit(sys.maxsize)

        with open(INPUT_FILENAME, mode='r', encoding='utf-8', newline='') as infile:
            reader = csv.reader(infile)
            try:
                header = next(reader)
            except StopIteration:
                print("Error: Input file is empty.")
                return
            
            file_number = 1
            total_rows = 0
            current_rows = []
            
            def write_chunk(rows, part_num):
                output_filename = f"wcvp_part_{part_num:02d}.csv"
                print(f"  Writing {output_filename} ({len(rows):,} rows)...")
                with open(output_filename, mode='w', encoding='utf-8', newline='') as outfile:
                    writer = csv.writer(outfile, quoting=csv.QUOTE_MINIMAL)
                    writer.writerow(header)
                    writer.writerows(rows)

            for row in reader:
                current_rows.append(row)
                total_rows += 1
                
                if len(current_rows) == ROWS_PER_FILE:
                    write_chunk(current_rows, file_number)
                    current_rows = []
                    file_number += 1
            
            # Write remaining rows
            if current_rows:
                write_chunk(current_rows, file_number)

        print(f"\nSuccess! Split {total_rows:,} rows into {file_number if current_rows else file_number - 1} files.")

    except Exception as e:
        print(f"\nFATAL ERROR: {str(e)}")

if __name__ == "__main__":
    split_csv()