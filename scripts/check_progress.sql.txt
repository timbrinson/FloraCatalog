-- =============================================================================
-- DATA IMPORT DIAGNOSTIC TOOL (v2.33.3)
-- =============================================================================

-- 0. STAGING TABLE AUDIT
SELECT 
    'WCVP Staging' as table, count(*) as row_count FROM wcvp_import
UNION ALL
SELECT 
    'WFO Staging' as table, count(*) as row_count FROM wfo_import
UNION ALL
SELECT 
    'App Taxa (Active)' as table, count(*) as row_count FROM app_taxa;

-- 1. OVERALL HEALTH & COMPLETION
SELECT 
    count(*) as total_plants,
    count(parent_id) as parents_linked,
    count(hierarchy_path) as paths_calculated,
    CASE 
        WHEN count(*) = 0 THEN '0% (TABLE EMPTY)'
        ELSE round(count(hierarchy_path) * 100.0 / count(*), 1) || '%' 
    END as overall_completion
FROM app_taxa;

-- 2. PROGRESS BY FAMILY GROUP
SELECT 
    CASE 
        WHEN family = 'Asteraceae' THEN 'Batch 1a: Asteraceae'
        WHEN family LIKE 'A%' AND family != 'Asteraceae' THEN 'Batch 1b: Other A'
        WHEN family LIKE 'B%' THEN 'Batch 1c: B'
        WHEN family LIKE 'C%' THEN 'Batch 1d: C'
        WHEN family LIKE 'D%' OR family LIKE 'E%' OR family LIKE 'F%' OR family LIKE 'G%' THEN 'Batch 2: D-G'
        WHEN family >= 'H' AND family < 'M' THEN 'Batch 3: H-L'
        WHEN family >= 'M' AND family < 'Q' THEN 'Batch 4: M-P'
        WHEN family >= 'Q' AND family < 'T' THEN 'Batch 5: Q-S'
        WHEN family >= 'T' THEN 'Batch 6: T-Z'
        ELSE 'Unknown'
    END as batch_group,
    count(*) as total_records,
    count(hierarchy_path) as paths_built,
    round(count(hierarchy_path) * 100.0 / NULLIF(count(*), 0), 1) || '%' as completion
FROM app_taxa
GROUP BY 1
ORDER BY 1;

-- 4. ACTIVE HIERARCHY WORKERS
SELECT 
    pid, state, now() - query_start as duration, query 
FROM pg_stat_activity 
WHERE query ILIKE '%app_taxa%' AND state != 'idle' AND pid != pg_backend_pid();

-- 10. THE BUILD DASHBOARD
SELECT
    (SELECT count(*) FROM app_taxa) as "Total Database Records",
    (SELECT count(*) - count(hierarchy_path) FROM app_taxa) as "Reset Progress (Cleaned)",
    (SELECT count(hierarchy_path) FROM app_taxa) as "Build Progress (Paths Built)",
    (SELECT round(count(hierarchy_path) * 100.0 / count(*), 1) || '%' FROM app_taxa) as "Overall Completion %";

-- 20. TAXONOMIC CENSUS
SELECT 
    taxon_rank,
    source_id,
    count(*) as physical_row_count
FROM app_taxa
GROUP BY 1, 2
ORDER BY physical_row_count DESC;

-- 22. PHASE 9 BACKBONE COMPLETION DETAIL
SELECT 
    taxon_rank,
    count(*) as total_in_rank,
    count(parent_id) as linked_to_parent,
    count(kingdom) as has_kingdom_literal,
    count("order") as has_order_literal
FROM app_taxa
WHERE source_id = 2
GROUP BY 1
ORDER BY 1;

-- 23. ZOMBIE BACKBONE DETECTION
SELECT 
    source_id,
    taxon_rank,
    count(*) as zombie_count,
    min(created_at) as oldest_record,
    max(created_at) as newest_record
FROM app_taxa
WHERE (source_id = 3 AND taxon_rank IN ('Kingdom', 'Phylum', 'Class', 'Order', 'Family'))
   OR (source_id = 2 AND taxon_rank = 'Family' AND taxon_status = 'Derived')
GROUP BY 1, 2
ORDER BY 1, 2;

-- 24. EMERGENCY KILL SWITCH (Run result to kill zombies)
-- SELECT 'SELECT pg_terminate_backend(' || pid || ');' as kill_cmd 
-- FROM pg_stat_activity 
-- WHERE query ILIKE '%app_taxa%' AND state != 'idle' AND pid != pg_backend_pid();