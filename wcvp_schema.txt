
-- Enable required extensions
CREATE EXTENSION IF NOT EXISTS ltree;

-- =============================================================================
-- RESET (DROP TABLES)
-- CAUTION: This deletes existing data to ensure the schema is correct.
-- =============================================================================

DROP TABLE IF EXISTS app_audit_log CASCADE;
DROP TABLE IF EXISTS app_taxon_source_records CASCADE;
DROP TABLE IF EXISTS app_taxon_details CASCADE;
DROP TABLE IF EXISTS app_taxa CASCADE;
DROP TABLE IF EXISTS app_attribute_definitions CASCADE;
DROP TABLE IF EXISTS app_data_sources CASCADE;
DROP TABLE IF EXISTS wcvp_import CASCADE;

-- =============================================================================
-- WCVP Import Schema (Staging Table)
-- Matches the column structure of the World Checklist of Vascular Plants CSV.
-- =============================================================================

CREATE TABLE wcvp_import (
    plant_name_id text PRIMARY KEY,
    ipni_id text,
    powo_id text,
    accepted_plant_name_id text,
    parent_plant_name_id text,
    basionym_plant_name_id text,
    homotypic_synonym text,
    taxon_name text,
    taxon_authors text,
    family text,
    genus text,
    genus_hybrid text,
    species text,
    species_hybrid text,
    infraspecies text,
    infraspecific_rank text,
    taxon_rank text,
    taxon_status text,
    hybrid_formula text,
    parenthetical_author text,
    primary_author text,
    publication_author text,
    replaced_synonym_author text,
    place_of_publication text,
    volume_and_page text,
    first_published text,
    nomenclatural_remarks text,
    reviewed text,
    geographic_area text,
    lifeform_description text,
    climate_description text
);

-- Indexes for Staging
CREATE INDEX idx_wcvp_name ON wcvp_import (taxon_name text_pattern_ops);
CREATE INDEX idx_wcvp_rank ON wcvp_import (taxon_rank);
CREATE INDEX idx_wcvp_parent ON wcvp_import (parent_plant_name_id);
CREATE INDEX idx_wcvp_accepted ON wcvp_import (accepted_plant_name_id);

-- =============================================================================
-- APPLICATION LAYER (FloraCatalog Core)
-- =============================================================================

-- 1. DATA SOURCES
CREATE TABLE app_data_sources (
    id serial PRIMARY KEY,
    name text NOT NULL,                -- e.g. "WCVP", "Gemini AI", "RHS"
    version text,                      -- e.g. "v14", "2.5-flash"
    citation_text text,                -- Full academic citation
    url text,                          -- Link to source
    trust_level int DEFAULT 1,         -- 1 (Low/AI) to 5 (Golden/WCVP)
    last_accessed_at timestamptz DEFAULT NOW()
);

-- 2. ATTRIBUTE REGISTRY (Data Dictionary)
CREATE TABLE app_attribute_definitions (
    key_name text PRIMARY KEY,         -- The actual JSON key (e.g. "leaf_shape")
    category text NOT NULL,            -- 'morphology', 'ecology', 'history'
    label text NOT NULL,               -- UI Display Name (e.g. "Leaf Shape")
    description text,                  -- Tooltip for the user
    data_type text NOT NULL,           -- 'text', 'number', 'boolean', 'select', 'multiselect'
    unit text,                         -- e.g. "cm", "days", "pH"
    options jsonb DEFAULT '[]',
    is_active boolean DEFAULT true,    -- If false, hide from UI but keep data
    display_order int DEFAULT 0
);

-- 3. TAXA (The Application's "Real" Table)
CREATE TABLE app_taxa (
    -- Internal UUID for the app (independent of WCVP IDs)
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Hierarchy (Adjacency List + Materialized Path)
    parent_id uuid REFERENCES app_taxa(id),
    hierarchy_path ltree,              -- Postgres ltree for efficient subtree queries
    
    -- Links to External IDs
    wcvp_id text REFERENCES wcvp_import(plant_name_id),
    ipni_id text,
    powo_id text,
    
    -- WCVP Relationship IDs
    accepted_plant_name_id text,
    parent_plant_name_id text,
    basionym_plant_name_id text,
    homotypic_synonym text,

    -- Core Taxonomy
    taxon_rank text NOT NULL,
    taxon_name text NOT NULL,          -- Full Scientific Name
    taxon_status text,                 -- 'Accepted', 'Synonym', 'Unplaced'
    family text,
    common_name text,
    
    -- Hybrid Markers
    genus text,                        -- Explicit Genus Column
    genus_hybrid char(1),              -- '×' or null
    species text,                      -- Explicit Species Column
    species_hybrid char(1),            -- '×' or null
    infraspecies text,
    infraspecific_rank text,
    cultivar text,                     -- Explicit Cultivar Column
    
    hybrid_formula text,               -- "Parent A x Parent B"

    -- Authorship (Fully Denormalized)
    taxon_authors text,
    parenthetical_author text,
    primary_author text,
    publication_author text,
    replaced_synonym_author text,

    -- Publication Data
    place_of_publication text,
    volume_and_page text,
    first_published text,
    nomenclatural_remarks text,
    reviewed text,                     -- 'Y' or 'N'

    -- Geography & Biology
    geographic_area text,
    lifeform_description text,
    climate_description text,
    
    -- Lineage / Meta
    source_id int REFERENCES app_data_sources(id), -- Where did this record primarily come from?
    verification_level text,           -- 'Verified', 'Unverified', 'Ambiguous'
    created_at timestamptz DEFAULT NOW(),
    updated_at timestamptz DEFAULT NOW(),
    
    -- Cached Metrics
    descendant_count int DEFAULT 0     -- Updated via trigger/worker
);

-- 4. GOLDEN RECORD (Consolidated Details)
CREATE TABLE app_taxon_details (
    taxon_id uuid PRIMARY KEY REFERENCES app_taxa(id) ON DELETE CASCADE,
    
    -- Description
    description_text text,
    description_source_id int REFERENCES app_data_sources(id),
    
    -- 4.1 CORE FILTERABLE TRAITS
    hardiness_zone_min int,            -- e.g. 7
    hardiness_zone_max int,            -- e.g. 10
    
    height_min_cm int,
    height_max_cm int,
    width_min_cm int,
    width_max_cm int,
    
    origin_year int,                   -- Year introduced/discovered
    
    -- 4.2 FLEXIBLE TRAITS (JSONB Bags)
    morphology jsonb DEFAULT '{}',     -- { "leaf_shape": "Ovate" }
    ecology jsonb DEFAULT '{}',        -- { "soil_type": "Loam" }
    history_metadata jsonb DEFAULT '{}',
    
    -- 4.3 PROVENANCE MAP
    field_sources jsonb DEFAULT '{}',
    
    -- 4.4 NAMING & LINKS
    alternative_names jsonb DEFAULT '[]',
    reference_links jsonb DEFAULT '[]'
);

-- 5. SOURCE ARCHIVE
CREATE TABLE app_taxon_source_records (
    id bigserial PRIMARY KEY,
    taxon_id uuid NOT NULL REFERENCES app_taxa(id) ON DELETE CASCADE,
    source_id int NOT NULL REFERENCES app_data_sources(id),
    raw_data jsonb NOT NULL,
    created_at timestamptz DEFAULT NOW(),
    import_batch_id text 
);

-- 6. AUDIT LOG
CREATE TABLE app_audit_log (
    id bigserial PRIMARY KEY,
    entity_id uuid NOT NULL,           -- Link to app_taxa.id
    table_name text NOT NULL,          -- 'app_taxa' or 'app_taxon_details'
    operation text NOT NULL,           -- 'INSERT', 'UPDATE', 'DELETE'
    changed_by_process text,           -- System Process Name (e.g. "MiningWorker", "BulkImport")
    user_id text,                      -- Identity of the user executing the command (if applicable)
    app_name text,                     -- e.g. "FloraCatalog"
    app_version text,                  -- e.g. "v2.9.1"
    changed_at timestamptz DEFAULT NOW(),
    changes jsonb                      -- { "field": { "old": "x", "new": "y" } }
);

-- =============================================================================
-- INDEXES
-- =============================================================================

CREATE INDEX idx_app_taxa_parent ON app_taxa(parent_id);
CREATE INDEX idx_app_taxa_name ON app_taxa(taxon_name);
CREATE INDEX idx_app_taxa_family ON app_taxa(family);
CREATE INDEX idx_app_path_gist ON app_taxa USING GIST (hierarchy_path);

-- =============================================================================
-- PERMISSIONS (DISABLE RLS FOR PROTOTYPE)
-- =============================================================================

ALTER TABLE wcvp_import DISABLE ROW LEVEL SECURITY;
ALTER TABLE app_data_sources DISABLE ROW LEVEL SECURITY;
ALTER TABLE app_attribute_definitions DISABLE ROW LEVEL SECURITY;
ALTER TABLE app_taxa DISABLE ROW LEVEL SECURITY;
ALTER TABLE app_taxon_details DISABLE ROW LEVEL SECURITY;
ALTER TABLE app_taxon_source_records DISABLE ROW LEVEL SECURITY;
ALTER TABLE app_audit_log DISABLE ROW LEVEL SECURITY;

-- =============================================================================
-- CACHE RELOAD (MAGIC COMMAND)
-- =============================================================================
NOTIFY pgrst, 'reload schema';
